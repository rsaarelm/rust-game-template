"use strict";const AudioContext=window.AudioContext||window.webkitAudioContext;let audio_context,sounds=new Map,playbacks=[],sound_key_next=1,playback_key_next=1;function audio_init(){if(audio_context==null){audio_context=new AudioContext;let t=audio_context.listener;{let n=window.AudioContext||window.webkitAudioContext,t=new n;var e=function(){console.log("fix"),audio_context.resume();var o=t.createBuffer(1,1,22050),s=t.createBufferSource();s.buffer=o,s.connect(t.destination),s.start?s.start(0):s.play?s.play(0):s.noteOn&&s.noteOn(0),document.removeEventListener("touchstart",e),document.removeEventListener("touchend",e),document.removeEventListener("mousedown",e),document.removeEventListener("keydown",e)};document.addEventListener("touchstart",e),document.addEventListener("touchend",e),document.addEventListener("mousedown",e),document.addEventListener("keydown",e)}}}function audio_add_buffer(e,t){let s=wasm_memory.buffer.slice(e,e+t),n=sound_key_next;return sound_key_next+=1,audio_context.decodeAudioData(s,function(e){sounds.set(n,e)},function(e){console.error("Failed to decode audio buffer",e)}),n}function audio_source_is_loaded(e){return sounds.has(e)&&sounds.get(e)!=void 0}function recycle_playback(){let e=playbacks.find(e=>e.sound_key===0);return e!=null?e.source=audio_context.createBufferSource():(e={sound_key:0,playback_key:0,source:audio_context.createBufferSource(),gain_node:audio_context.createGain(),ended:null},playbacks.push(e)),e}function stop(e){try{e.source.removeEventListener("ended",e.ended),e.source.disconnect(),e.gain_node.disconnect(),e.sound_key=0,e.playback_key=0}catch(e){console.error("Error stopping sound",e)}}function audio_play_buffer(e,t,n){let o=playback_key_next++,s=recycle_playback();s.sound_key=e,s.playback_key=o,s.source.connect(s.gain_node),s.gain_node.connect(audio_context.destination),s.gain_node.gain.value=t,s.source.loop=n,s.ended=function(){stop(s)},s.source.addEventListener("ended",s.ended);try{s.source.buffer=sounds.get(e),s.source.start(0)}catch(e){console.error("Error starting sound",e)}return o}function audio_source_set_volume(e,t){playbacks.forEach(n=>{n.sound_key===e&&(n.gain_node.gain.value=t)})}function audio_source_stop(e){playbacks.forEach(t=>{t.sound_key===e&&stop(t)})}function audio_source_delete(e){audio_source_stop(e),sounds.delete(e)}function audio_playback_stop(e){let t=playbacks.find(t=>t.playback_key===e);t!=null&&stop(t)}function audio_playback_set_volume(e,t){let n=playbacks.find(t=>t.playback_key===e);n!=null&&(n.gain_node.gain.value=t)}function register_plugin(e){e.env.audio_init=audio_init,e.env.audio_add_buffer=audio_add_buffer,e.env.audio_play_buffer=audio_play_buffer,e.env.audio_source_is_loaded=audio_source_is_loaded,e.env.audio_source_set_volume=audio_source_set_volume,e.env.audio_source_stop=audio_source_stop,e.env.audio_source_delete=audio_source_delete,e.env.audio_playback_stop=audio_playback_stop,e.env.audio_playback_set_volume=audio_playback_set_volume}miniquad_add_plugin({register_plugin,version:"0.1.0",name:"macroquad_audio"})